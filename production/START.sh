#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ                                                                            โ
# โ                    COCOLU VENTAS - SCRIPT DE INICIO                        โ
# โ                                                                            โ
# โ  Este script levanta TODO el sistema de una vez:                          โ
# โ  โข Dashboard (React)                                                      โ
# โ  โข API REST (Express)                                                     โ
# โ  โข Bot WhatsApp (BuilderBot + Meta)                                       โ
# โ                                                                            โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuraciรณn
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PORT=${PORT:-5001}
API_PORT=${API_PORT:-5000}
BOT_ADAPTER="meta"  # SOLO Meta para mejor rendimiento

echo -e "${BLUE}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                                                                            โ"
echo "โ                    COCOLU VENTAS - INICIANDO SISTEMA                       โ"
echo "โ                                                                            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${NC}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 1: VERIFICAR DEPENDENCIAS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}[1/5] Verificando dependencias...${NC}"

if ! command -v node &> /dev/null; then
    echo -e "${RED}โ Node.js no estรก instalado${NC}"
    exit 1
fi

if ! command -v npm &> /dev/null; then
    echo -e "${RED}โ npm no estรก instalado${NC}"
    exit 1
fi

NODE_VERSION=$(node -v)
NPM_VERSION=$(npm -v)

echo -e "${GREEN}โ Node.js ${NODE_VERSION}${NC}"
echo -e "${GREEN}โ npm ${NPM_VERSION}${NC}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 2: INSTALAR DEPENDENCIAS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${YELLOW}[2/5] Instalando dependencias...${NC}"

if [ ! -d "$PROJECT_DIR/node_modules" ]; then
    echo -e "${BLUE}  โ Instalando dependencias del backend...${NC}"
    cd "$PROJECT_DIR"
    npm install --legacy-peer-deps > /dev/null 2>&1
    echo -e "${GREEN}  โ Backend listo${NC}"
else
    echo -e "${GREEN}  โ Backend ya tiene dependencias${NC}"
fi

if [ ! -d "$PROJECT_DIR/dashboard/node_modules" ]; then
    echo -e "${BLUE}  โ Instalando dependencias del dashboard...${NC}"
    cd "$PROJECT_DIR/dashboard"
    npm install --legacy-peer-deps > /dev/null 2>&1
    echo -e "${GREEN}  โ Dashboard listo${NC}"
else
    echo -e "${GREEN}  โ Dashboard ya tiene dependencias${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 3: COMPILAR DASHBOARD
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${YELLOW}[3/5] Compilando dashboard...${NC}"

if [ ! -d "$PROJECT_DIR/dashboard/build" ]; then
    echo -e "${BLUE}  โ Compilando React...${NC}"
    cd "$PROJECT_DIR/dashboard"
    GENERATE_SOURCEMAP=false npm run build > /dev/null 2>&1
    echo -e "${GREEN}  โ Dashboard compilado${NC}"
else
    echo -e "${GREEN}  โ Dashboard ya estรก compilado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 4: VERIFICAR CONFIGURACIรN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${YELLOW}[4/5] Verificando configuraciรณn...${NC}"

if [ ! -f "$PROJECT_DIR/.env" ]; then
    echo -e "${RED}โ๏ธ  Archivo .env no encontrado${NC}"
    echo -e "${YELLOW}  Crea un archivo .env con las variables de Meta:${NC}"
    echo -e "    META_JWT_TOKEN=tu_token"
    echo -e "    META_NUMBER_ID=tu_numero"
    echo -e "    META_VERIFY_TOKEN=tu_verify_token"
else
    echo -e "${GREEN}  โ Archivo .env encontrado${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 5: INICIAR SISTEMA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${YELLOW}[5/5] Iniciando sistema...${NC}"
echo ""

cd "$PROJECT_DIR"

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}โ                                                                            โ${NC}"
echo -e "${BLUE}โ                    ๐ SISTEMA INICIANDO                                    โ${NC}"
echo -e "${BLUE}โ                                                                            โ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# Iniciar con variables de entorno
PORT=$PORT API_PORT=$API_PORT BOT_ADAPTER=$BOT_ADAPTER NODE_ENV=production npm start

