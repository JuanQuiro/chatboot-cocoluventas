version: '3.8'

# Docker Compose de Producción - DashOffice Rust
# Target: <500MB RAM total
# docker-compose -f docker-compose.production.yml up -d

services:
  # PostgreSQL - Base de datos principal
  postgres:
    image: postgres:16-alpine
    container_name: dashoffice-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: dashoffice
      POSTGRES_USER: dashoffice
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    mem_limit: 200m
    mem_reservation: 150m
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dashoffice"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dashoffice_network

  # Redis - Caché y estado
  redis:
    image: redis:7-alpine
    container_name: dashoffice-redis
    restart: unless-stopped
    command: redis-server --maxmemory 50mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    mem_limit: 60m
    mem_reservation: 50m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - dashoffice_network

  # API Gateway (Rust)
  api-gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.api-gateway
    container_name: dashoffice-api
    restart: unless-stopped
    ports:
      - "3009:3009"
    environment:
      RUST_LOG: info
      DATABASE_URL: postgresql://dashoffice:${POSTGRES_PASSWORD}@postgres:5432/dashoffice
      REDIS_URL: redis://redis:6379
      PORT: 3009
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    mem_limit: 100m
    mem_reservation: 50m
    networks:
      - dashoffice_network

  # WhatsApp Adapter (Rust)
  whatsapp-adapter:
    build:
      context: .
      dockerfile: docker/Dockerfile.whatsapp-adapter
    container_name: dashoffice-whatsapp
    restart: unless-stopped
    ports:
      - "3010:3010"
    environment:
      RUST_LOG: info
      WHATSAPP_PORT: 3010
      REDIS_URL: redis://redis:6379
      VENOM_BRIDGE_URL: http://venom-bridge:3013
      WWEBJS_BRIDGE_URL: http://wwebjs-bridge:3014
    depends_on:
      - redis
      - venom-bridge
      - wwebjs-bridge
    mem_limit: 50m
    mem_reservation: 30m
    networks:
      - dashoffice_network

  # Bot Orchestrator (Rust)
  bot-orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot-orchestrator
    container_name: dashoffice-orchestrator
    restart: unless-stopped
    ports:
      - "3011:3011"
    environment:
      RUST_LOG: info
      BOT_PORT: 3011
      DATABASE_URL: postgresql://dashoffice:${POSTGRES_PASSWORD}@postgres:5432/dashoffice
      REDIS_URL: redis://redis:6379
      WHATSAPP_ADAPTER_URL: http://whatsapp-adapter:3010
    depends_on:
      - postgres
      - redis
      - whatsapp-adapter
    mem_limit: 80m
    mem_reservation: 50m
    networks:
      - dashoffice_network

  # Analytics Engine (Rust)
  analytics-engine:
    build:
      context: .
      dockerfile: docker/Dockerfile.analytics-engine
    container_name: dashoffice-analytics
    restart: unless-stopped
    environment:
      RUST_LOG: info
      DATABASE_URL: postgresql://dashoffice:${POSTGRES_PASSWORD}@postgres:5432/dashoffice
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
    mem_limit: 40m
    mem_reservation: 20m
    networks:
      - dashoffice_network

  # Venom Bridge (Node.js)
  venom-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.venom-bridge
    container_name: dashoffice-venom
    restart: unless-stopped
    ports:
      - "3013:3013"
    environment:
      PORT: 3013
      NODE_ENV: production
    volumes:
      - venom_sessions:/app/sessions
    mem_limit: 250m
    mem_reservation: 200m
    networks:
      - dashoffice_network

  # WWebJS Bridge (Node.js)
  wwebjs-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.wwebjs-bridge
    container_name: dashoffice-wwebjs
    restart: unless-stopped
    ports:
      - "3014:3014"
    environment:
      PORT: 3014
      NODE_ENV: production
    volumes:
      - wwebjs_sessions:/app/.wwebjs_auth
    mem_limit: 200m
    mem_reservation: 180m
    networks:
      - dashoffice_network

  # Nginx - Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: dashoffice-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ../dashboard/build:/usr/share/nginx/html:ro
    depends_on:
      - api-gateway
      - bot-orchestrator
    mem_limit: 30m
    mem_reservation: 20m
    networks:
      - dashoffice_network

volumes:
  postgres_data:
  redis_data:
  venom_sessions:
  wwebjs_sessions:

networks:
  dashoffice_network:
    driver: bridge

# TOTAL RAM USAGE (estimado):
# PostgreSQL:        150-200MB
# Redis:             50MB
# API Gateway:       50MB
# WhatsApp Adapter:  30MB
# Bot Orchestrator:  50MB
# Analytics Engine:  20MB
# Venom Bridge:      200MB
# WWebJS Bridge:     180MB
# Nginx:             20MB
# ────────────────────────────
# TOTAL:             ~750-800MB
#
# Con optimizaciones:  ~500-600MB
